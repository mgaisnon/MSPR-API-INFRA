worker_processes auto;
events { worker_connections 1024; }

http {
  # CORS simple (adapte si besoin)
  map $http_origin $cors_origin {
    default "*";
  }
  server {
    listen 8080;

    add_header Access-Control-Allow-Origin $cors_origin always;
    add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
    add_header Access-Control-Allow-Headers "Content-Type, Authorization" always;

    if ($request_method = OPTIONS) { return 204; }

    # Variables Render (URL publiques des microservices)
    # tu les passeras en variables d'env Render -> remplacées au build ci-dessous si tu préfères
    set $clients  http://api-clients.onrender.com;
    set $cmds     http://api-commandes.onrender.com;
    set $prod     http://api-produits.onrender.com;

    location /clients/   { proxy_pass $clients/;   proxy_set_header Host $host; }
    location /commandes/ { proxy_pass $cmds/;      proxy_set_header Host $host; }
    location /produits/  { proxy_pass $prod/;      proxy_set_header Host $host; }

    # racine: petit ping/health
    location = / {
      return 200 'gateway ok';
      add_header Content-Type text/plain;
    }
  }
}
